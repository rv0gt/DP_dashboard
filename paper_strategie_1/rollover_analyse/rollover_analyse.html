<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Strategie 1 - Rollover Analyse</title>
    <!-- Shared CSS and JS -->
    <link rel="stylesheet" href="../../_shared/css/common.css">
    <script src="../../_shared/js/includes.js"></script>
    <!-- Chart.js Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; background-color: #fff; }
        .hero { background: linear-gradient(135deg, #0a2540 0%, #0d3a5c 50%, #134e7a 100%); padding: 0; text-align: center; min-height: 28vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0, 102, 204, 0.3), transparent), radial-gradient(ellipse 60% 40% at 100% 100%, rgba(0, 163, 255, 0.15), transparent), url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23ffffff" fill-opacity="0.02"%3E%3Cpath d="M0 40L40 0H20L0 20M40 40V20L20 40"/%3E%3C/g%3E%3C/svg%3E'); background-size: auto, auto, 40px 40px; animation: subtleFloat 20s ease-in-out infinite; }
        @keyframes subtleFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .hero::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 100px; background: linear-gradient(to top, rgba(10, 37, 64, 0.8), transparent); pointer-events: none; }
        .hero-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px 30px 40px; position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; width: 100%; }
        .breadcrumb { margin-bottom: 20px; }
        .breadcrumb a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 14px; }
        .breadcrumb a:hover { color: #fff; }
        .breadcrumb span { color: rgba(255,255,255,0.5); margin: 0 10px; }
        .hero h1 { font-size: 42px; font-weight: 300; color: #fff; margin-bottom: 10px; line-height: 1.1; letter-spacing: -0.5px; }
        .hero p { color: rgba(255,255,255,0.7); font-size: 18px; }
        .stats-section { background: linear-gradient(180deg, #0f3554 0%, #0a2540 100%); padding: 40px 30px 50px; }
        .stats-grid { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 25px 15px; border-radius: 12px; text-align: center; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.08); }
        .stat-number { font-size: 24px; font-weight: 600; color: #fff; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: rgba(255, 255, 255, 0.7); }
        .warning { color: #fbbf24; }
        .danger { color: #f87171; }
        .success { color: #4ade80; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 30px; }
        .chart-section { padding: 60px 30px; background: #f8f9fa; }
        .section-title { font-size: 24px; font-weight: 300; color: #333; margin-bottom: 30px; text-align: center; }
        .chart-card { background: #fff; border: 1px solid #e9ecef; border-radius: 12px; padding: 30px; margin-bottom: 30px; }
        .chart-wrapper { height: 300px; position: relative; }
        .info-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-card { background: #fff; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; }
        .info-card h3 { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .info-card .value { font-size: 28px; font-weight: 700; color: #0066cc; margin-bottom: 5px; }
        .info-card .label { font-size: 13px; color: #666; }
        .table-section { padding: 60px 30px; background: #fff; }
        .table-container { background: #fff; border: 1px solid #e9ecef; border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px 12px; text-align: left; font-size: 13px; font-weight: 600; color: #666; text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
        td { padding: 14px 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr:hover { background: #f8f9fa; }
        tr:last-child td { border-bottom: none; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #cce5ff; color: #004085; }
        .footer { background: #333; color: #fff; padding: 25px 30px; text-align: center; }
        .footer p { font-size: 13px; color: #999; }
        .last-update { text-align: center; color: #666; font-size: 14px; margin-top: 30px; }
        @media (max-width: 800px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .hero h1 { font-size: 28px; } }
        @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }

        /* Navigation and breadcrumb styles from common.css */
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>
    <section class="hero">
        <div class="hero-content">
            <div class="breadcrumb">
                <a href="../../dashboard_analyse.html">Home</a>
                <span class="breadcrumb-separator">/</span>
                <a href="../overview.html">Paper Strategie 1</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Rollover Analyse</span>
            </div>
            <h1>Rollover Analyse</h1>
            <p>Paper Strategie 1 - Kontraktverwaltung und Rollover-Historie</p>
        </div>
    </section>
    <section class="stats-section">
        <div class="stats-grid" id="metrics">
            <div class="stat-card"><div class="stat-number">â€”</div><div class="stat-label">Aktueller Kontrakt</div></div>
            <div class="stat-card"><div class="stat-number">â€”</div><div class="stat-label">Verfall</div></div>
            <div class="stat-card"><div class="stat-number">â€”</div><div class="stat-label">Tage bis Verfall</div></div>
            <div class="stat-card"><div class="stat-number">â€”</div><div class="stat-label">Rollover Status</div></div>
        </div>
    </section>
    <section class="chart-section">
        <div class="container">
            <h2 class="section-title">Kontrakt-Ãœbersicht</h2>
            <div class="info-cards" id="info-cards">
                <div class="info-card"><h3>ðŸ“… NÃ¤chster Rollover</h3><div class="value" id="next-rollover">â€”</div><div class="label">Tage bis zum nÃ¤chsten Rollover</div></div>
                <div class="info-card"><h3>ðŸ’µ Letzte Rollover-Kosten</h3><div class="value" id="last-rollover-cost">â€”</div><div class="label">Kosten des letzten Rollovers</div></div>
                <div class="info-card"><h3>ðŸ“Š Rollover-Anzahl</h3><div class="value" id="rollover-count">â€”</div><div class="label">Rollovers in den letzten 90 Tagen</div></div>
            </div>
            <div class="chart-card">
                <h3 style="font-size:18px; font-weight:400; margin-bottom:20px; text-align:center;">Tage bis Verfall (Verlauf)</h3>
                <div class="chart-wrapper"><canvas id="expiryChart"></canvas></div>
            </div>
        </div>
    </section>
    <section class="table-section">
        <div class="container">
            <h2 class="section-title">Rollover-Ereignisse</h2>
            <div class="table-container">
                <table id="events-table">
                    <thead><tr><th>Datum</th><th>Aktion</th><th>Kontrakt</th><th>Verfall</th><th>Schlusspreis</th><th>Kosten</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="7" style="text-align:center">Lade Daten...</td></tr></tbody>
                </table>
            </div>
            <h2 class="section-title" style="margin-top:50px">Kontrakt-Historie</h2>
            <div class="table-container">
                <table id="history-table">
                    <thead><tr><th>Datum</th><th>Kontrakt</th><th>Verfall</th><th>Tage bis Verfall</th></tr></thead>
                    <tbody><tr><td colspan="4" style="text-align:center">Lade Daten...</td></tr></tbody>
                </table>
            </div>
            <div class="last-update" id="last-update"></div>
        </div>
    </section>
    <footer class="footer"><p>Paper Strategie 1 - Rollover Analyse Â· Trading Dashboard</p></footer>
    <script>
        async function loadJSONData(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Fehler ${response.status}`);
            return response.json();
        }
        function updateLastUpdate(timestamp, elementId = 'last-update') {
            if (!timestamp) return;
            const el = document.getElementById(elementId);
            if (el) el.innerHTML = `Letzte Aktualisierung: ${new Date(timestamp).toLocaleString('de-DE')}`;
        }
        const DATA_URL = './rollover_analyse.json';
        let expiryChart;
        async function loadData() {
            try {
                const data = await loadJSONData(DATA_URL);
                const rd = data.rollover_data;
                if (rd) {
                    updateMetrics(rd.current);
                    updateInfoCards(rd);
                    updateChart(rd.history, rd.current);
                    updateEventsTable(rd.events);
                    updateHistoryTable(rd.history);
                }
                updateLastUpdate(data.timestamp);
            } catch (e) { console.error('Fehler:', e); }
        }
        function updateMetrics(c) {
            if (!c) return;
            const days = parseInt(c.tage_bis_verfall || 0);
            let cls = days <= 3 ? 'danger' : days <= 7 ? 'warning' : 'success';
            document.getElementById('metrics').innerHTML = `
                <div class="stat-card"><div class="stat-number" style="font-size:18px">${c.kontraktname || 'â€”'}</div><div class="stat-label">Aktueller Kontrakt</div></div>
                <div class="stat-card"><div class="stat-number" style="font-size:18px">${c.kontrakt_verfall || 'â€”'}</div><div class="stat-label">Verfall</div></div>
                <div class="stat-card"><div class="stat-number ${cls}">${days} Tage</div><div class="stat-label">Tage bis Verfall</div></div>
                <div class="stat-card"><div class="stat-number">${c.rollover_stattgefunden ? 'Ja' : 'Nein'}</div><div class="stat-label">Rollover Status</div></div>`;
        }
        function updateInfoCards(rd) {
            document.getElementById('next-rollover').textContent = (rd.current?.tage_bis_verfall || 0) + ' Tage';
            const lastE = rd.events?.find(e => e.rollover_kosten);
            document.getElementById('last-rollover-cost').textContent = lastE?.rollover_kosten ? '$' + parseFloat(lastE.rollover_kosten).toFixed(2) : 'â€”';
            document.getElementById('rollover-count').textContent = rd.events?.length || 0;
        }
        function updateChart(history, current) {
            if (!history || history.length === 0) return;
            const sorted = [...history].sort((a, b) => new Date(a.datum) - new Date(b.datum));
            const dataPoints = sorted.map(h => ({ x: new Date(h.datum), y: h.tage_bis_verfall }));
            const lastDate = dataPoints[dataPoints.length - 1].x;
            const maxDate = new Date(lastDate.getTime() + 10 * 24 * 60 * 60 * 1000);
            let expiryDate = null;
            if (current?.kontrakt_verfall) {
                expiryDate = new Date(current.kontrakt_verfall);
            } else if (sorted.length > 0) {
                const last = sorted[sorted.length - 1];
                expiryDate = new Date(new Date(last.datum).getTime() + last.tage_bis_verfall * 24 * 60 * 60 * 1000);
            }
            const ctx = document.getElementById('expiryChart').getContext('2d');
            if (expiryChart) expiryChart.destroy();
            expiryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Tage bis Verfall',
                        data: dataPoints,
                        borderColor: '#0066cc',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 4,
                        pointBackgroundColor: dataPoints.map(p => p.y <= 3 ? '#f87171' : p.y <= 7 ? '#fbbf24' : '#0066cc')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ctx.parsed.y + ' Tage bis Verfall' } },
                        annotation: {
                            annotations: expiryDate ? {
                                expiryLine: {
                                    type: 'line',
                                    xMin: expiryDate,
                                    xMax: expiryDate,
                                    borderColor: '#f87171',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: 'Verfall',
                                        position: 'start',
                                        backgroundColor: '#f87171',
                                        color: '#fff',
                                        font: { size: 11 }
                                    }
                                }
                            } : {}
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'dd.MM.yy' }, tooltipFormat: 'dd.MM.yyyy HH:mm' },
                            max: maxDate,
                            grid: { color: '#f0f0f0' },
                            title: { display: true, text: 'Datum' }
                        },
                        y: {
                            grid: { color: '#f0f0f0' },
                            min: 0,
                            ticks: { callback: v => v + ' Tage' },
                            title: { display: true, text: 'Tage bis Verfall' }
                        }
                    }
                }
            });
        }
        function updateEventsTable(events) {
            const tbody = document.querySelector('#events-table tbody');
            if (!events || events.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">Keine Rollover-Ereignisse</td></tr>'; return; }
            tbody.innerHTML = events.map(e => `<tr><td>${new Date(e.date_chi).toLocaleString('de-DE')}</td><td>${e.rollover_aktion || 'â€”'}</td><td>${e.kontraktname || 'â€”'}</td><td>${e.kontrakt_verfall || 'â€”'}</td><td>${e.rollover_schlusspreis ? '$' + parseFloat(e.rollover_schlusspreis).toFixed(2) : 'â€”'}</td><td>${e.rollover_kosten ? '$' + parseFloat(e.rollover_kosten).toFixed(2) : 'â€”'}</td><td><span class="badge ${e.rollover_stattgefunden ? 'badge-success' : 'badge-info'}">${e.rollover_stattgefunden ? 'Abgeschlossen' : 'Ausstehend'}</span></td></tr>`).join('');
        }
        function updateHistoryTable(history) {
            const tbody = document.querySelector('#history-table tbody');
            if (!history || history.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Keine Daten</td></tr>'; return; }
            tbody.innerHTML = history.slice(0, 30).map(h => {
                const d = parseInt(h.tage_bis_verfall || 0);
                return `<tr><td>${h.datum}</td><td>${h.kontraktname || 'â€”'}</td><td>${h.kontrakt_verfall || 'â€”'}</td><td><span class="badge ${d <= 3 ? 'badge-warning' : 'badge-success'}">${d} Tage</span></td></tr>`;
            }).join('');
        }
        loadData();
        setInterval(loadData, 60000);

        // Initialize shared includes
        initIncludes({ activeNav: 'nav-dashboard', loadCSS: false });
    </script>
</body>
</html>